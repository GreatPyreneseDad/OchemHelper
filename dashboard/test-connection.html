<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Claude Connection</title>
    <style>
        body {
            font-family: monospace;
            background: #0a0e27;
            color: #e0e6ed;
            padding: 2rem;
        }
        .test-section {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #63b3ed;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #63b3ed; }
        button {
            background: #4c1d95;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0;
        }
        button:hover {
            background: #5b21b6;
        }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>OChem Helper Connection Test</h1>
    
    <div class="test-section">
        <h2>1. API Key Status</h2>
        <div id="api-key-status"></div>
        <button onclick="setApiKey()">Set API Key</button>
        <button onclick="testApiKey()">Test API Key</button>
    </div>

    <div class="test-section">
        <h2>2. Service Connections</h2>
        <div id="service-status"></div>
        <button onclick="testServices()">Test All Services</button>
    </div>

    <div class="test-section">
        <h2>3. Claude API Test</h2>
        <div id="claude-test"></div>
        <button onclick="testClaude()">Test Claude Connection</button>
    </div>

    <div class="test-section">
        <h2>4. MCP Server Test</h2>
        <div id="mcp-test"></div>
        <button onclick="testMCP()">Test MCP Connection</button>
    </div>

    <div class="test-section">
        <h2>5. Console Output</h2>
        <pre id="console-output"></pre>
    </div>

    <script>
        const API_KEY = ''; // Set this in localStorage instead
        
        function log(message, type = 'info') {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<span class="${color}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function checkApiKey() {
            const storedKey = localStorage.getItem('claude_api_key');
            const status = document.getElementById('api-key-status');
            
            if (storedKey) {
                status.innerHTML = `<span class="success">✓ API Key found in localStorage</span><br>
                                   <span class="info">Key: ${storedKey.substring(0, 20)}...</span>`;
                log('API key found in localStorage', 'success');
            } else {
                status.innerHTML = `<span class="error">✗ No API key found</span>`;
                log('No API key found', 'error');
            }
        }

        function setApiKey() {
            const key = prompt('Enter your Claude API key (sk-ant-...):', localStorage.getItem('claude_api_key') || '');
            if (key) {
                localStorage.setItem('claude_api_key', key);
                log('API key set in localStorage', 'success');
                checkApiKey();
            }
        }

        async function testApiKey() {
            log('Testing Claude API key...', 'info');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': localStorage.getItem('claude_api_key') || '',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-opus-20240229',
                        max_tokens: 10,
                        messages: [{
                            role: 'user',
                            content: 'Say "Hello"'
                        }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    log('Claude API key is valid! Response: ' + JSON.stringify(data), 'success');
                } else {
                    const error = await response.text();
                    log('Claude API error: ' + error, 'error');
                }
            } catch (error) {
                log('Failed to connect to Claude API: ' + error.message, 'error');
            }
        }

        async function testServices() {
            const services = [
                { name: 'OChem API', url: 'http://localhost:8000/health' },
                { name: 'MCP Bridge', url: 'http://localhost:8001/health' },
                { name: 'Dashboard', url: 'http://localhost:8080/' }
            ];

            const statusDiv = document.getElementById('service-status');
            statusDiv.innerHTML = '';

            for (const service of services) {
                try {
                    const response = await fetch(service.url);
                    if (response.ok) {
                        statusDiv.innerHTML += `<div class="success">✓ ${service.name} is running</div>`;
                        log(`${service.name} is running`, 'success');
                    } else {
                        statusDiv.innerHTML += `<div class="error">✗ ${service.name} returned ${response.status}</div>`;
                        log(`${service.name} error: ${response.status}`, 'error');
                    }
                } catch (error) {
                    statusDiv.innerHTML += `<div class="error">✗ ${service.name} is not reachable</div>`;
                    log(`${service.name} not reachable: ${error.message}`, 'error');
                }
            }
        }

        async function testClaude() {
            log('Testing Claude integration...', 'info');
            const testDiv = document.getElementById('claude-test');
            
            try {
                // Load Claude API module
                const script = document.createElement('script');
                script.src = 'claude-api.js';
                document.head.appendChild(script);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (window.ClaudeAPI) {
                    const claude = new window.ClaudeAPI();
                    const response = await claude.sendMessage('What is benzene?', {});
                    testDiv.innerHTML = `<div class="success">✓ Claude responded: ${response.message.substring(0, 100)}...</div>`;
                    log('Claude integration working!', 'success');
                } else {
                    testDiv.innerHTML = `<div class="error">✗ Claude API module not loaded</div>`;
                    log('Claude API module not found', 'error');
                }
            } catch (error) {
                testDiv.innerHTML = `<div class="error">✗ Error: ${error.message}</div>`;
                log('Claude test failed: ' + error.message, 'error');
            }
        }

        async function testMCP() {
            log('Testing MCP connection...', 'info');
            const testDiv = document.getElementById('mcp-test');
            
            try {
                const response = await fetch('http://localhost:8001/list_tools', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const data = await response.json();
                    testDiv.innerHTML = `<div class="success">✓ MCP tools available: ${data.tools.map(t => t.name).join(', ')}</div>`;
                    log('MCP connection successful', 'success');
                } else {
                    testDiv.innerHTML = `<div class="error">✗ MCP error: ${response.status}</div>`;
                    log('MCP error: ' + response.status, 'error');
                }
            } catch (error) {
                testDiv.innerHTML = `<div class="error">✗ MCP not reachable: ${error.message}</div>`;
                log('MCP connection failed: ' + error.message, 'error');
            }
        }

        // Run initial check
        checkApiKey();
        log('Test page loaded. Click buttons to test connections.', 'info');
    </script>
</body>
</html>